---
title: '2019-06-19:setTimeout 倒计时为什么会出现误差？'
date: 2019-06-19 11:06:42
tags: [面试]
---


## 前言 
这是来自于参与刘小夕同学的GitHub项目的每日一题，[地址在此](https://github.com/YvetteLau/Step-By-Step/issues/21)，感兴趣的同学可以联系她哟～

这个问题要从根本上理解，请先认真读[这篇文章](https://juejin.im/post/5a6547d0f265da3e283a1df7)，我每次读一遍，都能领悟到一些东西。

## 倒计时为啥会出现误差
在基于上面的文章的内容，因为可能在它推入事件列表时，主线程还不空闲，正在执行其他的代码，所以自然有误差。

### 事件循环机制
主线程运行时会产生执行栈，
* 栈中的代码调用某些api时，它们会在事件队列中添加各种事件（当满足触发条件后，如ajax请求完毕）
* 而栈中的代码执行完毕，就会读取事件队列中的事件，去执行那些回调
* 如此循环
* 注意，总是要等待栈中的代码执行完毕后才会去读取事件队列中的事件

### 定时器
上述事件循环机制的核心是：JS引擎线程和事件触发线程
但事件上，里面还有一些隐藏细节，譬如调用setTimeout后，是如何等待特定时间后才添加到事件队列中的？
是JS引擎检测的么？当然不是了。它是由定时器线程控制（因为JS引擎自己都忙不过来，根本无暇分身）
为什么要单独的定时器线程？因为JavaScript引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确，因此很有必要单独开一个线程用来计时。
什么时候会用到定时器线程？当使用setTimeout或setInterval时，它需要定时器线程计时，计时完成后就会将特定的事件推入事件队列中。


